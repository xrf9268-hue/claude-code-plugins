name: Validate Plugin Configurations

on:
  # Run on pull requests
  pull_request:
    paths:
      - 'plugins/**/*.json'
      - 'plugins/**/SKILL.md'
      - '.claude-plugin/**'
      - 'Script/validate-all.sh'
      - '.github/workflows/validate-plugins.yml'

  # Run on pushes to main branches
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'plugins/**/*.json'
      - 'plugins/**/SKILL.md'
      - '.claude-plugin/**'
      - 'Script/validate-all.sh'

  # Allow manual triggering
  workflow_dispatch:

# Minimal permissions (security best practice)
permissions:
  contents: read
  pull-requests: write  # For commenting on PRs

# Ensure only one validation runs at a time per PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Plugin Configurations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Cache jq installation
        uses: actions/cache@v4
        id: cache-jq
        with:
          path: /usr/bin/jq
          key: ${{ runner.os }}-jq-1.7

      - name: Install jq
        if: steps.cache-jq.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Verify jq installation
        run: |
          which jq
          jq --version

      - name: Make validation script executable
        run: chmod +x Script/validate-all.sh

      - name: Run validation
        id: validate
        run: |
          # Run validation and capture output
          set +e  # Don't exit on error, we want to capture it
          ./Script/validate-all.sh 2>&1 | tee validation-output.log
          VALIDATION_EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=${VALIDATION_EXIT_CODE}" >> $GITHUB_OUTPUT
          exit ${VALIDATION_EXIT_CODE}

      - name: Upload validation report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation-output.log
          retention-days: 30

      - name: Comment on PR with validation results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('validation-output.log', 'utf8');

            const body = `## ❌ Plugin Validation Failed

            The plugin configuration validation has failed. Please review and fix the errors below:

            <details>
            <summary>Validation Output</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            ### How to Fix

            1. Review the errors above
            2. Run \`./Script/validate-all.sh\` locally to reproduce
            3. Fix the issues in your plugin configurations
            4. Commit and push your fixes

            See [Plugin Maintenance Guide](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/PLUGIN_MAINTENANCE_GUIDE.md) for help.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR with success
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ✅ Plugin Validation Passed

            All plugin configurations are valid and meet quality standards!

            - ✅ JSON syntax valid
            - ✅ Required fields present
            - ✅ Hook structures correct
            - ✅ Metadata complete
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Set job summary
        if: always()
        run: |
          if [ "${{ steps.validate.outputs.exit_code }}" = "0" ]; then
            echo "## ✅ Validation Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All plugin configurations passed validation." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the validation output above for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
            echo "- [Plugin Maintenance Guide](https://github.com/${{ github.repository }}/blob/main/docs/PLUGIN_MAINTENANCE_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
            echo "- [Implementation Plan](https://github.com/${{ github.repository }}/blob/main/IMPLEMENTATION_PLAN.md)" >> $GITHUB_STEP_SUMMARY
          fi

  # Additional job to check for common issues
  lint-json:
    name: Lint JSON Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate JSON syntax
        run: |
          echo "Checking JSON files for syntax errors..."
          EXIT_CODE=0

          # Check all plugin.json files
          for file in $(find plugins -name "plugin.json" -o -name "hooks.json" -o -name "marketplace.json"); do
            echo "Validating: $file"
            if ! jq empty "$file" 2>/dev/null; then
              echo "❌ Invalid JSON in: $file"
              EXIT_CODE=1
            else
              echo "✅ Valid: $file"
            fi
          done

          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "❌ JSON validation failed"
            exit 1
          fi

          echo ""
          echo "✅ All JSON files are valid"

      - name: Check for trailing commas
        run: |
          echo "Checking for trailing commas in JSON files..."

          # Trailing commas are not valid in JSON
          if grep -r ",\s*}" plugins/ --include="*.json" || grep -r ",\s*]" plugins/ --include="*.json"; then
            echo "❌ Found trailing commas in JSON files (shown above)"
            exit 1
          fi

          echo "✅ No trailing commas found"

      - name: Check for tabs in JSON
        run: |
          echo "Checking for tabs in JSON files (should use spaces)..."

          # JSON should use spaces, not tabs
          if grep -rP "\t" plugins/ --include="*.json"; then
            echo "⚠️ Found tabs in JSON files (should use spaces)"
            echo "This is a style warning, not a blocker"
          else
            echo "✅ No tabs found"
          fi

  # Security check job
  security-check:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for secrets in configurations
        run: |
          echo "Scanning for potential secrets in configuration files..."

          # Check for common secret patterns
          FINDINGS=0

          # Check for potential API keys
          if grep -rE "(api[_-]?key|apikey|api[_-]?secret)" plugins/ --include="*.json" --include="*.md" -i; then
            echo "⚠️ Found potential API key references (review manually)"
            FINDINGS=$((FINDINGS + 1))
          fi

          # Check for potential passwords
          if grep -rE "password\s*[:=]" plugins/ --include="*.json" --include="*.md" -i; then
            echo "⚠️ Found potential password references (review manually)"
            FINDINGS=$((FINDINGS + 1))
          fi

          # Check for potential tokens
          if grep -rE "token\s*[:=].*[a-zA-Z0-9]{20,}" plugins/ --include="*.json" --include="*.md" -i; then
            echo "⚠️ Found potential token values (review manually)"
            FINDINGS=$((FINDINGS + 1))
          fi

          if [ $FINDINGS -eq 0 ]; then
            echo "✅ No obvious secrets found in configurations"
          else
            echo ""
            echo "ℹ️ Found $FINDINGS potential security concern(s)"
            echo "Please review the findings above manually"
            echo "Note: This is informational only and won't block the workflow"
          fi

  # Job summary
  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate, lint-json, security-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Plugin Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration Validation | ${{ needs.validate.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Linting | ${{ needs.lint-json.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | ${{ needs.security-check.result == 'success' && '✅ Passed' || '⚠️ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate.result }}" = "success" ] && [ "${{ needs.lint-json.result }}" = "success" ]; then
            echo "### ✅ All Checks Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your plugin configurations meet all quality standards." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Some Checks Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed jobs above and fix the issues." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if validation failed
        if: needs.validate.result != 'success' || needs.lint-json.result != 'success'
        run: |
          echo "One or more validation checks failed"
          exit 1
